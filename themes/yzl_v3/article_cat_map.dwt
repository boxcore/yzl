<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <!-- #BeginLibraryItem "/library/common/head.lbi" --><!-- #EndLibraryItem -->
  {insert_scripts files='index.js'}
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=2f18a21f61a57e50df7511a057da7002"></script>
</head>
<body>
<!-- #BeginLibraryItem "/library/page_header.lbi" --><!-- #EndLibraryItem -->


<div class="content">
    <div class="left">
        <!-- TemplateBeginEditable name="左边区域" -->
        <!-- {if $article_categories} -->
        <!-- #BeginLibraryItem "/library/common/article_category_tree.lbi" --><!-- #EndLibraryItem -->
        <!-- {/if} -->
        <!-- TemplateEndEditable -->
    </div>
    <div class="right">
        <h2><span>{$cat_info.cat_name}</span></h2>
        {if $cat_detail1}{$cat_detail}{/if}
        <div class="webmap_top">
            <p>查询地图</p>
            <form action="/page/22/" method="post" id="map_form">
                <ul class="map_con">
                    {*<li>省份<select name=""><option>重庆</option><option>北京</option></select></li>*}
                    <li>城市
                        <select name="city" id="city_sec">
                            <option value="32" {if $smarty.post.city eq 32}selected{/if}>重庆</option>
                            <option value="2" {if $smarty.post.city eq 2}selected{/if}>北京</option>
                        </select>
                    </li>
                    {*<li>分址<select name="" class="add"><option>重庆</option><option>北京</option></select></li>*}
                </ul>
            </form>
        </div>

        <div class="yzl_add">

            {foreach from=$map_list item=map name=foo}
                <p><span>{$map.map_name}</span><span> 地址：{$map.address}</span><span>客服电话：{$map.tel}</span></p>
                {/foreach}
        </div>
        <style>
            {noitreal}
            #l-map{width:856px; height:410px; border:1px solid #ccc;}
        </style>
        <div class="map" id="l-map"></div>{*<img src="images/map.jpg" width="856" height="410">*}

    </div>
</div>

<!-- #BeginLibraryItem "/library/page_footer.lbi" --><!-- #EndLibraryItem -->
</body>
</html>
<script type="text/javascript">

    // 百度地图API功能
    var map = new BMap.Map("l-map");
    //map.centerAndZoom(new BMap.Point(116.328749,40.026922), 13);//
    map.centerAndZoom("{$city_name}",12);
    var index = 0;
    var myGeo = new BMap.Geocoder();
    var adds = [
            {foreach from=$map_list item=map name=foo}
            new BMap.Point({$map.map_point}),
            {/foreach}
    ];
    var sContents = [
        {foreach from=$map_list item=map name=foo}
        "<h4 style='margin:0 0 5px 0;padding:0.2em 0'>{$map.map_name}</h4><p style='margin:0;line-height:1.5;font-size:13px;text-indent:2em'>{$map.map_desc}<br>电话：{$map.tel}</p></div>",
        {/foreach}
    ];


    for(var i = 0; i<adds.length; i++){
        var marker = new BMap.Marker(adds[i]);
        map.addOverlay(marker);
        openInfoWinFun(marker, adds[i], sContents[i]);
    }

    function openInfoWinFun(mark, point, content){
        var infoWindow = new BMap.InfoWindow(content);  // 创建信息窗口对象
        mark.addEventListener("click", function(){
            this.openInfoWindow(infoWindow);
            //图片加载完毕重绘infowindow
//            document.getElementById('imgDemo').onload = function (){
//                infoWindow.redraw();   //防止在网速较慢，图片未加载时，生成的信息框高度比图片的总高度小，导致图片部分被隐藏
//            }
        });
    }


    function bdGEO(){
        var pt = adds[index];
        geocodeSearch(pt);
        index++;
    }
    function geocodeSearch(pt){
        if(index < adds.length){
            setTimeout(window.bdGEO,300);
        }
        myGeo.getLocation(pt, function(rs){
            var addComp = rs.addressComponents;
            document.getElementById("result").innerHTML += index + ". " +adds[index-1].lng + "," + adds[index-1].lat + "："  + "商圈(" + rs.business + ")  结构化数据(" + addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber + ")<br/><br/>";
        });
    };




</script>
